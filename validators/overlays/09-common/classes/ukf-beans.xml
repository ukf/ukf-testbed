<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    default-lazy-init="true"
    xmlns:c="http://www.springframework.org/schema/c"
    xmlns:p="http://www.springframework.org/schema/p"
    xmlns:util="http://www.springframework.org/schema/util"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
    http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd">

    <!--
        Define beans related specifically to the UK federation deployment.

        Most beans used are defined by the parent context, and come from
        common-beans.xml (which imports validation-beans.xml). This configuration
        supplements that with the UK federation-specific configuration.
    -->

    <!--
        Import UK channel-specific beans.
    -->
    <import resource="classpath:uk/beans.xml"/>

    <!--
        Import inc-mda beans.
    -->
    <import resource="classpath:uk/org/iay/incommon/mda/beans.xml"/>

    <!--
        Import UK federation ingress policy for eduGAIN.
    -->
    <import resource="classpath:uk/edugain-policy.xml"/>

    <!--
        checkCertificates

        This bean is defined as an inner bean in common-beans.xml but inner
        beans can't be referenced. This is a literal copy of that bean.
    -->
    <bean id="checkCertificates" parent="mda.X509ValidationStage">
        <property name="validators">
            <list>
                <!-- Error on DSA keys. -->
                <bean p:id="DSA" parent="ukf.X509DSADetector"/>

                <!-- Error on RSA key length less than 2048 bits. -->
                <bean p:id="RSAKeyLength" parent="mda.X509RSAKeyLengthValidator"
                    p:warningBoundary="0" p:errorBoundary="2048"/>
                <!-- Error on small RSA public exponents. -->
                <bean p:id="RSAExponent" parent="mda.X509RSAExponentValidator"/>
                <!-- Error on keys vulnerable to ROCA. -->
                <bean p:id="ROCA" parent="ukf.X509ROCAValidator"/>

                <!--
                    Debian weak key blacklists.

                    Don't need to check for keys below our minimum key size.
                -->
                <ref bean="debian.2048"/>
                <ref bean="debian.4096"/>

                <!--
                    Compromised key blacklists.

                    Again, don't need to check for keys below our minimum key size.
                -->
                <ref bean="compromised.2048"/>
            </list>
        </property>
    </bean>

    <!--
        checkScopes

        This bean is defined as an inner bean in edugain-policy.xml but inner
        beans can't be referenced. This is a literal copy of that bean.
    -->
    <bean id="checkScopes" parent="inc.stage_parent"
        class="uk.org.iay.incommon.mda.dom.saml.shib.ScopeValidationStage">
        <property name="validators">
            <list>
                <bean p:id="empty" parent="inc.RejectStringRegexValidator"
                    p:regex="" p:message="scope element must not be empty"/>
                <bean p:id="whiteSpace" parent="inc.RejectStringRegexValidator"
                    p:regex=".*\s.*" p:message="scope '%s' includes white space"/>

                <!--
                    Explicitly accept domains which, although they
                    fall afoul of the public suffic heuristic, are
                    nevertheless known to be legitimately used as
                    security domains.
                -->
                <bean p:id="mil.no" parent="inc.AcceptStringValueValidator"
                    p:value="mil.no"/>

                <bean p:id="domainName" parent="inc.AsDomainNameStringValidator"
                    p:message="scope is not a valid domain name: %s">
                    <property name="validators">
                        <list>
                            <!-- DNS name validators -->
                            <bean p:id="publicSuffix" parent="inc.RejectDomainNamePublicSuffixValidator"
                                p:message="scope is a public suffix: '%s'"/>
                            <bean p:id="noPublicSuffix" parent="inc.RejectDomainNameNotUnderPublicSuffixValidator"
                                p:message="scope is not under a public suffix: '%s'"/>
                        </list>
                    </property>
                </bean>
            </list>
        </property>
        <property name="regexpValidators">
            <list>
                <bean p:id="empty" parent="inc.RejectStringRegexValidator"
                    p:regex="" p:message="regex scope element must not be empty"/>
                <bean p:id="whiteSpace" parent="inc.RejectStringRegexValidator"
                    p:regex=".*\s.*" p:message="regex scope '%s' includes white space"/>
                <bean p:id="endAnchor" parent="inc.RejectStringRegexValidator"
                    p:regex=".*[^$]" p:message="regex scope '%s' does not end with an anchor ('$')"/>
                <bean p:id="literalTail" parent="inc.AsLiteralTailStringValidator"
                    p:message="regular expression '%s' does not end with a literal tail">
                    <property name="validators">
                        <!-- validators to apply to the literal tail -->
                        <list>
                            <bean p:id="domainName" parent="inc.AsDomainNameStringValidator"
                                p:message="literal tail is not a valid domain name: %s">
                                <property name="validators">
                                    <list>
                                        <!-- DNS name validators for the literal tail -->
                                        <bean p:id="publicSuffix" parent="inc.RejectDomainNamePublicSuffixValidator"
                                            p:message="literal tail is a public suffix: '%s'"/>
                                        <bean p:id="noPublicSuffix" parent="inc.RejectDomainNameNotUnderPublicSuffixValidator"
                                            p:message="literal tail is not under a public suffix: '%s'"/>
                                    </list>
                                </property>
                            </bean>
                        </list>
                    </property>
                </bean>
            </list>
        </property>
    </bean>

</beans>
